{"version":3,"file":"UNSAFE_Layer.js","sources":["../../src/UNSAFE_Layer/LayerContext.ts","../../src/UNSAFE_Layer/Layer.tsx","../../src/UNSAFE_Layer/LayerHost.tsx","../../src/UNSAFE_Layer/LayerManager.tsx"],"sourcesContent":["import { createContext } from 'preact';\n\nexport type LayerContextProps = {\n  getHost?: () => Element;\n};\n\nexport const LayerContext = createContext<LayerContextProps>({});\n","import { VNode, RefObject } from 'preact';\nimport { createPortal, useContext, useLayoutEffect, useMemo, useState } from 'preact/compat';\nimport { LayerContext } from './LayerContext';\n\nconst _LOGICAL_PARENT = '__oj_logical_parent';\n\ntype Props = {\n  /**\n   * The content to be re-parented using Portal\n   */\n  children: VNode;\n  /**\n   * Logical parent of the re-parented content. Typically the 'launcher' associated\n   * with the popup.\n   */\n  logicalParentRef?: RefObject<Element> | null;\n};\n\ntype LayerElement = HTMLDivElement & {\n  __oj_logical_parent?: Element | null;\n};\n\nconst Layer = (props: Props) => {\n  const context = useContext(LayerContext);\n  const defaultHost = context.getHost?.();\n  const host = useMemo(() => defaultHost, [defaultHost]);\n  const [layerContainer, setLayerContainer] = useState<Element | null>(null);\n\n  // Really need useLayoutEffect instead of useEffect here. Otherwise the re-parented\n  // content does not get re-rendered with valid ref's\n  useLayoutEffect(() => {\n    if (!host) return;\n    const doc = host.ownerDocument ?? document;\n    const layer: LayerElement = doc.createElement('div');\n\n    if (props.logicalParentRef) {\n      layer[_LOGICAL_PARENT] = props.logicalParentRef.current;\n    }\n\n    host.appendChild(layer);\n    setLayerContainer(layer);\n\n    return () => {\n      if (host && layer && host.contains(layer)) {\n        delete layer[_LOGICAL_PARENT];\n        host.removeChild(layer);\n      }\n      setLayerContainer(null);\n    };\n  }, [host]);\n\n  return layerContainer && createPortal(props.children, layerContainer);\n};\n\nexport default Layer;\n","/**\n * The LayerHost is a div which is created in place\n * where you want to \"house\" a portaled content\n */\nimport { forwardRef } from 'preact/compat';\n\nconst LayerHost = forwardRef<HTMLDivElement>((_props, ref) => {\n  return <div id=\"__oj_layerhost_container\" ref={ref} />;\n});\n\nLayerHost.displayName = 'Forwarded<LayerHost>';\n\nexport default LayerHost;\n","/**\n * The LayerManager wraps your application and creates two adjacent divs for\n * rendering your application and housing Layers.\n */\nimport { ComponentChildren } from 'preact';\nimport { useCallback, useState } from 'preact/compat';\nimport { LayerContext, LayerContextProps } from './LayerContext';\nimport LayerHost from './LayerHost';\n\ntype LayerManagerProps = {\n  children?: ComponentChildren;\n};\n\nexport function LayerManager({ children }: LayerManagerProps) {\n  const [defaultHost, setDefaultHost] = useState<Element>();\n  //const context = useContext(LayerContext);\n  const defaultHostRef = useCallback((el: Element | null) => {\n    // ref callbacks fire after the component has been unnmounted so we do not\n    // want to set state in this use-case\n    if (el !== null) {\n      setDefaultHost(el);\n    }\n  }, []);\n\n  return (\n    <LayerContext.Consumer>\n      {(value: LayerContextProps) => {\n        const defaultHostContext = defaultHost ? { getHost: () => defaultHost } : {};\n        const layerContext = value.getHost ? value : defaultHostContext;\n        return (\n          <LayerContext.Provider value={layerContext}>\n            {children}\n            {!value.getHost && <LayerHost ref={defaultHostRef} />}\n          </LayerContext.Provider>\n        );\n      }}\n    </LayerContext.Consumer>\n  );\n}\n"],"names":["LayerContext","createContext","_LOGICAL_PARENT","LayerHost","forwardRef","_props","ref","_jsx","id","displayName","props","context","useContext","defaultHost","_a","getHost","host","useMemo","layerContainer","setLayerContainer","useState","useLayoutEffect","layer","ownerDocument","document","createElement","logicalParentRef","current","appendChild","contains","removeChild","createPortal","children","setDefaultHost","defaultHostRef","useCallback","el","Consumer","value","defaultHostContext","layerContext","_jsxs","jsxs","Provider","Object","assign"],"mappings":"sGAMaA,EAAeC,EAAaA,cAAoB,ICFvDC,EAAkB,sBCElBC,EAAYC,EAAUA,WAAiB,CAACC,EAAQC,IAC7CC,EAAAA,IAAA,MAAA,CAAKC,GAAG,2BAA2BF,IAAKA,KAGjDH,EAAUM,YAAc,+BDYTC,UACb,MAAMC,EAAUC,aAAWZ,GACrBa,UAAcC,EAAAH,EAAQI,sCACtBC,EAAOC,EAAAA,QAAQ,IAAMJ,EAAa,CAACA,KAClCK,EAAgBC,GAAqBC,EAAQA,SAAiB,MAyBrE,OArBAC,EAAAA,gBAAgB,WACd,IAAKL,EAAM,OACX,MACMM,GADwB,QAAlBR,EAAAE,EAAKO,qBAAa,IAAAT,EAAAA,EAAIU,UACFC,cAAc,OAS9C,OAPIf,EAAMgB,mBACRJ,EAAMpB,GAAmBQ,EAAMgB,iBAAiBC,SAGlDX,EAAKY,YAAYN,GACjBH,EAAkBG,GAEX,KACDN,GAAQM,GAASN,EAAKa,SAASP,YAC1BA,EAAMpB,GACbc,EAAKc,YAAYR,IAEnBH,EAAkB,QAEnB,CAACH,IAEGE,GAAkBa,EAAYA,aAACrB,EAAMsB,SAAUd,oCEtCxC,UAAac,SAAEA,IAC7B,MAAOnB,EAAaoB,GAAkBb,EAAQA,WAExCc,EAAiBC,cAAaC,IAGvB,OAAPA,GACFH,EAAeG,IAEhB,IAEH,OACE7B,EAAAA,IAACP,EAAaqC,SACX,CAAAL,SAACM,IACA,MAAMC,EAAqB1B,EAAc,CAAEE,QAAS,IAAMF,GAAgB,GACpE2B,EAAeF,EAAMvB,QAAUuB,EAAQC,EAC7C,OACEE,EAACC,KAAA1C,EAAa2C,SAASC,OAAAC,OAAA,CAAAP,MAAOE,GAC3B,CAAAR,SAAA,CAAAA,GACCM,EAAMvB,SAAWR,EAAAA,IAACJ,EAAS,CAACG,IAAK4B"}